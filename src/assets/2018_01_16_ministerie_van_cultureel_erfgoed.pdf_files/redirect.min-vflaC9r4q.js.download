define(["require","exports","tslib","modules/clean/ajax","external/lodash","modules/core/i18n","modules/core/cookies","modules/core/notify","modules/core/uri","modules/clean/api_v2/transport/fetch","modules/clean/react/modal","modules/clean/react/extensions/auth_modal","modules/clean/filepath","modules/clean/react/extensions/cloud_docs_compat","modules/clean/cloud_docs/event_logging","modules/clean/cloud_docs/open_with_utils"],(function(e,t,r,n,i,o,a,c,s,u,d,l,_,h,f,p){"use strict";function m(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,o,c,d;return r.__generator(this,(function(r){if(i=new u.FetchAsyncTransport,o=new s.URI({scheme:"https",authority:"www.dropbox.com",path:"/2/app_actions/"+t}),(c={})["X-Dropbox-Path-Root"]=e.root_ns_id.toString(),c["X-Dropbox-Uid"]=e.id.toString(),!(d=a.Cookies.read("__Host-js_csrf")))throw new Error("No CSRF cookie");return(c["X-CSRF-Token"]=d,[2,i.executeRpc(o,c,JSON.stringify(n),"application/json")])}))}))}function w(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,o;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,m(e,t,n)];case 1:return i=r.sent(),o={request_id:i.headers["x-dropbox-request-id"],redirect_url:i.result.redirect_url},"link_state"in i.result&&(o.link_state=i.result.link_state),[2,o]}}))}))}function g(e,t,n,i,o){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,b(e,t,n,i,(function(){return w(e,"redirect",{action_id:t,file_id:i})}),o)];case 1:return r.sent(),[2]}}))}))}function v(e,t,n,i,o){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,b(e,t,n,i,(function(){return w(e,"authorize",{action_id:t,file_id:i})}),o)];case 1:return[2,r.sent()]}}))}))}function b(e,t,a,s,u,d){return r.__awaiter(this,void 0,Promise,(function(){function l(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,u()];case 1:return[2,e.sent()];case 2:return e.sent(),f=!0,[2,void 0];case 3:return[2]}}))}))}var _,h,f,p,m,w,g,v;return r.__generator(this,(function(r){switch(r.label){case 0:return _="action_redirect_"+Math.random().toString(16).substring(2),(h=window.open("",_,d))&&(h.document.open("text/html","replace"),h.document.write("<html><head><title>"+i.escape(a)+"</title></head></html>"),h.document.close()),f=!1,p=new Promise((function(r){n.SilentBackgroundRequest({url:"/aa/loading",subject_user:e.id,data:{file_id:s,action_id:t},success:function(e){!f&&h?(h.document.open("text/html","replace"),h.document.write(e),h.document.close(),h.document.title=a,r()):r()},error:function(){r()}})})),[4,Promise.all([p,l()])];case 1:return m=r.sent(),w=m[1],g=w&&w.redirect_url||"/aa/error",h?h.location.replace(g):window.open(g,"_blank",d)||(v=a,c.Notify.error(o.intl.formatMessage({id:"TFhSer",defaultMessage:"Failed to open {app_name}"},{app_name:v}))),[2,w]}}))}))}Object.defineProperty(t,"__esModule",{value:!0}),n=r.__importStar(n),i=r.__importStar(i),_=r.__importStar(_),t.fetch=m,t.fetchUrl=w,t.authorizeNoRedirect=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,m(e,"authorize_no_redirect",{action_id:t})];case 1:return[2,(n=r.sent())&&n.result&&n.result.link_state];case 2:return r.sent(),[2,null];case 3:return[2]}}))}))},t.redirectToAction=g,t.redirectToActionOrShowAuth=function(e,t,n,i,o,a,c){return r.__awaiter(this,void 0,void 0,(function(){var i,s,u,m,w,b,k;return r.__generator(this,(function(x){if("redirect"===n.handler[".tag"])i=n.handler.window_params,s=void 0,"popup"===i[".tag"]&&(u=i.width,m=i.height,s="width="+u+",height="+m),"sfa_unlinked"===n.link_state[".tag"]&&!n.id.startsWith("fp_action_id:")?(w=_.filename(t.ns_path),l.showAuthModal(n.id,n.description,n.icon.url,t.file_id,w,(function(){d.Modal.close(),(function(e,t,n,i,o,a){r.__awaiter(this,void 0,void 0,(function(){var c;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,v(e,t,n,i,o)];case 1:return c=r.sent(),a&&c&&c.link_state&&a(t,c.link_state),[2]}}))}))})(e,n.id,n.description,t.file_id,s,a)}))):g(e,n.id,n.description,t.file_id,s);else if("cloud_editor"===n.handler[".tag"])b=o?f.getActionSourceFromSurface(o.surface):void 0,k=h.cloudEditorNameToParams(n.handler.editor_name),p.openWithCloudEditor(p.fileToOpenWithParams(t),e.id,k,!1,b);else{if("profile_service"!==n.handler[".tag"])throw new Error('Unexpected handler "'+n.handler[".tag"]+'"');c&&c(e,t,n)}return[2]}))}))},t.authAction=v,t.showLoadingPageAndDoRedirect=b}));
//# sourceMappingURL=redirect.min.js-vflMQwcOC.map